name: Deploy KingHost 2.0

on:
  release:
    types: [published]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Preparar known_hosts e fingerprint
        run: |
          set -euo pipefail
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            touch ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
            
      - name: Diagnóstico de rede até o SSH da KingHost
        run: |
          set -x
          echo "Host: ${{ secrets.KINGHOST_HOST }}  Porta: ${{ secrets.KINGHOST_PORT }}"
          # Resolver DNS
          getent ahostsv4 "${{ secrets.KINGHOST_HOST }}" || true
          # Testar TCP na porta
          nc -vz -w 5 "${{ secrets.KINGHOST_HOST }}" "${{ secrets.KINGHOST_PORT }}" || true
      
      - name: Registrar fingerprint
        run: |
          set -euo pipefail
          ssh-keyscan -H -p "${{ secrets.KINGHOST_PORT }}" "${{ secrets.KINGHOST_HOST }}" >> ~/.ssh/known_hosts

      - name: Instalar sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Deploy remoto via SSH com senha
        run: |
          sshpass -p "${{ secrets.KINGHOST_PASSWORD }}" \
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.KINGHOST_PORT }}" \
            "${{ secrets.KINGHOST_USER }}@${{ secrets.KINGHOST_HOST }}" << 'EOF'
            set -euo pipefail

            echo "Ativando Node v22.1.0"
            export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
            fi
            if command -v nvm >/dev/null 2>&1; then
              nvm install 22.1.0 >/dev/null
              nvm use 22.1.0
            elif [ -x "$NVM_DIR/versions/node/v22.1.0/bin/node" ]; then
              export PATH="$NVM_DIR/versions/node/v22.1.0/bin:$PATH"
            else
              echo "nvm/Node 22.1.0 indisponível no servidor." >&2
              exit 1
            fi
            node -v | grep -q '^v22\.1\.0' || { echo "Node ativo não é 22.1.0"; exit 1; }

            echo "Preparando diretório"
            mkdir -p ~/apps_nodejs
            cd ~/apps_nodejs
            if [ -d site-pericia ]; then
              rm -rf antigo || true
              mv site-pericia antigo
            fi

            echo "Clonando repositório"
            git clone https://github.com/brunorichter/site-pericia.git

            echo "Restaurando .env"
            if [ -f antigo/.env ]; then
              cp -R antigo/.env site-pericia/.env
            else
              echo "Aviso: antigo/.env não encontrado. Pulei cópia."
            fi

            echo "Instalando dependências e build"
            cd site-pericia
            if command -v npm >/dev/null 2>&1; then
              npm ci || npm install
              npm run build
            else
              echo "npm não encontrado." >&2
              exit 1
            fi

            echo "Reiniciando PM2"
            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart site-pericia || pm2 start ecosystem.config.js --only site-pericia || pm2 start npm --name site-pericia -- run start
              pm2 save || true
            else
              echo "pm2 não encontrado." >&2
              exit 1
            fi

            echo "Deploy concluído"
          EOF