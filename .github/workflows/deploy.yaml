name: Deploy KingHost

on:
  release:
    types: [published]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verificar fingerprint SSH (opcional, mas recomendado)
        run: |
          ssh-keyscan -p "${{ secrets.KINGHOST_PORT }}" "${{ secrets.KINGHOST_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy remoto por SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.KINGHOST_HOST }}
          username: ${{ secrets.KINGHOST_USER }}
          key: ${{ secrets.KINGHOST_SSH_KEY }}
          port: ${{ secrets.KINGHOST_PORT }}
          script: |
            set -euo pipefail

            echo "Ativando Node v22.1.0"
            export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
            fi
            if command -v nvm >/dev/null 2>&1; then
              nvm install 22.1.0 >/dev/null
              nvm use 22.1.0
            elif [ -x "$NVM_DIR/versions/node/v22.1.0/bin/node" ]; then
              export PATH="$NVM_DIR/versions/node/v22.1.0/bin:$PATH"
            else
              echo "nvm/Node 22.1.0 indisponível no servidor." >&2
              exit 1
            fi
            node -v | grep -q '^v22\.1\.0' || { echo "Node ativo não é 22.1.0"; exit 1; }

            echo "Preparando diretório"
            mkdir -p ~/apps_nodejs
            cd ~/apps_nodejs
            if [ -d site-pericia ]; then
              rm -rf antigo || true
              mv site-pericia antigo
            fi

            echo "Clonando repositório"
            git clone https://github.com/brunorichter/site-pericia.git

            echo "Restaurando .env"
            if [ -f antigo/.env ]; then
              cp -R antigo/.env site-pericia/.env
            else
              echo "Aviso: antigo/.env não encontrado. Pulei cópia."
            fi

            echo "Instalando dependências e build"
            cd site-pericia
            if command -v npm >/dev/null 2>&1; then
              npm ci || npm install
              npm run build
            else
              echo "npm não encontrado." >&2
              exit 1
            fi

            echo "Reiniciando PM2"
            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart site-pericia || pm2 start ecosystem.config.js --only site-pericia || pm2 start npm --name site-pericia -- run start
              pm2 save || true
            else
              echo "pm2 não encontrado." >&2
              exit 1
            fi

            echo "Deploy concluído"
